name: Testing and Release Pipeline

on:
  workflow_run:
    workflows: ["CD Pipeline"]
    types:
      - completed
    branches: [main]
  schedule:
    # Run DAST tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - integration
        - dast
        - e2e
        - security-only
      target_environment:
        description: 'Environment to test against'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_performance_tests:
        description: 'Skip performance baseline tests'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'Create release after successful tests'
        required: false
        default: true
        type: boolean

env:
  STAGING_URL: https://vulnapp67-staging.azurewebsites.net
  PRODUCTION_URL: https://vulnapp67.azurewebsites.net
  TARGET_URL: ${{ github.event.inputs.target_environment == 'production' && 'https://vulnapp67.azurewebsites.net' || 'https://vulnapp67-staging.azurewebsites.net' }}

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Wait for staging deployment
      timeout-minutes: 10
      run: |
        echo "Waiting for target environment to be ready..."
        TARGET_URL="${{ env.TARGET_URL }}"
        echo "Testing against: ${TARGET_URL}"
        for i in {1..10}; do
          if curl -f -s --max-time 10 "${TARGET_URL}" > /dev/null; then
            echo "‚úÖ Target environment is ready!"
            break
          fi
          echo "‚è≥ Waiting for environment... (attempt $i/10)"
          if [ $i -eq 10 ]; then
            echo "‚ùå Environment not ready after 10 attempts"
            echo "::error::Target environment ${TARGET_URL} is not responding"
            exit 1
          fi
          sleep 30
        done

    - name: Run API Integration Tests
      run: |
        TARGET_URL="${{ env.TARGET_URL }}"
        echo "Running integration tests against target environment: ${TARGET_URL}"
        
        # Test basic connectivity
        echo "Testing basic connectivity..."
        curl -f "${TARGET_URL}" || exit 1
        
        # Test main endpoints
        echo "Testing main endpoints..."
        curl -f "${TARGET_URL}/" || exit 1
        curl -f "${TARGET_URL}/about" || exit 1
        curl -f "${TARGET_URL}/contact" || exit 1
        
        # Test POST endpoints (if available)
        echo "Testing POST endpoints..."
        curl -X POST -H "Content-Type: application/json" \
             -d '{"email":"test@example.com","message":"test"}' \
             "${TARGET_URL}/contact" || true
        
        echo "‚úÖ Integration tests completed successfully!"

    - name: Performance baseline test
      if: github.event.inputs.skip_performance_tests != 'true'
      run: |
        TARGET_URL="${{ env.TARGET_URL }}"
        echo "Running performance baseline tests against: ${TARGET_URL}"
        
        # Simple load test using curl with error handling
        echo "Testing response times..."
        SUCCESS=0
        for i in {1..5}; do
          echo "Test ${i}/5..."
          if time curl -f -s -w "Response time: %{time_total}s\n" "${TARGET_URL}" > /dev/null; then
            ((SUCCESS++))
          else
            echo "‚ùå Request ${i} failed"
          fi
        done
        
        echo "‚úÖ Performance baseline test completed! Success rate: ${SUCCESS}/5"
        if [ ${SUCCESS} -lt 3 ]; then
          echo "::warning::Performance test success rate below 60%"
        fi

  dast-security-tests:
    name: DAST Security Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'dast' || github.event.inputs.test_type == 'security-only' || github.event_name == 'schedule' || github.event_name == 'workflow_run'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: ${{ env.TARGET_URL }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
      continue-on-error: true

    - name: OWASP ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: ${{ env.TARGET_URL }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
      continue-on-error: true

    - name: Nuclei Vulnerability Scan
      uses: projectdiscovery/nuclei-action@main
      with:
        target: ${{ env.TARGET_URL }}
        github-report: true
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload DAST Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-reports
        path: |
          report_html.html
          report_json.json
          nuclei-report.json

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' || github.event_name == 'workflow_run'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --only=production

    - name: Run Basic E2E Tests
      run: |
        TARGET_URL="${{ env.TARGET_URL }}"
        echo "Running basic E2E tests against: ${TARGET_URL}"
        
        # Create simple Node.js test script
        cat > basic-e2e-test.js << 'EOF'
        const http = require('http');
        const https = require('https');
        const url = require('url');

        const targetUrl = process.env.TARGET_URL || 'http://localhost:3000';
        const parsedUrl = url.parse(targetUrl);
        const client = parsedUrl.protocol === 'https:' ? https : http;

        console.log('üß™ Starting basic E2E tests...');

        function makeRequest(path, callback) {
          const options = {
            hostname: parsedUrl.hostname,
            port: parsedUrl.port || (parsedUrl.protocol === 'https:' ? 443 : 80),
            path: path,
            method: 'GET',
            timeout: 10000
          };

          const req = client.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => callback(null, { statusCode: res.statusCode, data }));
          });

          req.on('error', callback);
          req.on('timeout', () => callback(new Error('Request timeout')));
          req.end();
        }

        // Test 1: Homepage
        makeRequest('/', (err, result) => {
          if (err) {
            console.error('‚ùå Homepage test failed:', err.message);
            process.exit(1);
          }
          if (result.statusCode === 200) {
            console.log('‚úÖ Homepage loads successfully');
          } else {
            console.log(`‚ö†Ô∏è  Homepage returned status: ${result.statusCode}`);
          }

          // Test 2: About page
          makeRequest('/about', (err, result) => {
            if (err) {
              console.log('‚ö†Ô∏è  About page test failed:', err.message);
            } else if (result.statusCode === 200) {
              console.log('‚úÖ About page loads successfully');
            } else {
              console.log(`‚ö†Ô∏è  About page returned status: ${result.statusCode}`);
            }

            // Test 3: Contact page
            makeRequest('/contact', (err, result) => {
              if (err) {
                console.log('‚ö†Ô∏è  Contact page test failed:', err.message);
              } else if (result.statusCode === 200) {
                console.log('‚úÖ Contact page loads successfully');
              } else {
                console.log(`‚ö†Ô∏è  Contact page returned status: ${result.statusCode}`);
              }

              // Test 4: XSS vulnerability test
              const xssPayload = encodeURIComponent('<script>alert("xss")</script>');
              makeRequest(`/search?q=${xssPayload}`, (err, result) => {
                if (err) {
                  console.log('‚ö†Ô∏è  XSS test failed:', err.message);
                } else {
                  if (result.data.includes('<script>alert("xss")</script>')) {
                    console.log('‚ö†Ô∏è  XSS vulnerability detected as expected');
                  }
                  console.log('‚úÖ XSS test completed');
                }

                console.log('üéâ Basic E2E tests completed');
              });
            });
          });
        });
        EOF

        # Run the Node.js test
        TARGET_URL="${TARGET_URL}" node basic-e2e-test.js

    - name: Upload E2E Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          basic-e2e-test.js

  security-compliance-check:
    name: Security Compliance Check
    runs-on: ubuntu-latest
    needs: [dast-security-tests]
    if: always()
    
    steps:
    - name: Download DAST Reports
      uses: actions/download-artifact@v4
      with:
        name: dast-reports
        path: dast-reports/

    - name: Analyze Security Results
      run: |
        echo "Analyzing security scan results..."
        
        # Check for critical vulnerabilities
        CRITICAL_ISSUES=0
        HIGH_ISSUES=0
        
        if [ -f "dast-reports/report_json.json" ]; then
          echo "Processing ZAP scan results..."
          # Parse JSON for critical/high issues (simplified)
          CRITICAL_ISSUES=$(cat dast-reports/report_json.json | grep -o '"riskcode":"3"' | wc -l || echo "0")
          HIGH_ISSUES=$(cat dast-reports/report_json.json | grep -o '"riskcode":"2"' | wc -l || echo "0")
        fi
        
        echo "Critical issues found: $CRITICAL_ISSUES"
        echo "High issues found: $HIGH_ISSUES"
        
        # Create security summary
        cat > security-summary.md << EOF
        # Security Compliance Report
        
        ## Scan Date: $(date)
        ## Target: ${{ env.TARGET_URL }}
        
        ### Results Summary
        - Critical Issues: $CRITICAL_ISSUES
        - High Issues: $HIGH_ISSUES
        
        ### Compliance Status
        EOF
        
        if [ "$CRITICAL_ISSUES" -gt 0 ]; then
          echo "‚ùå FAILED - Critical security issues found" >> security-summary.md
          echo "::error::Critical security vulnerabilities detected"
        elif [ "$HIGH_ISSUES" -gt 5 ]; then
          echo "‚ö†Ô∏è  WARNING - Multiple high-severity issues found" >> security-summary.md
          echo "::warning::Multiple high-severity vulnerabilities detected"
        else
          echo "‚úÖ PASSED - Security compliance acceptable" >> security-summary.md
        fi

    - name: Upload Security Summary
      uses: actions/upload-artifact@v4
      with:
        name: security-compliance-report
        path: security-summary.md

  release-management:
    name: Release Management
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests, security-compliance-check]
    if: github.ref == 'refs/heads/main' && (success() || failure())
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all test artifacts
      uses: actions/download-artifact@v4

    - name: Generate Release Notes
      run: |
        echo "# Release Notes - $(date '+%Y-%m-%d %H:%M:%S')" > release-notes.md
        echo "" >> release-notes.md
        echo "## Deployment Information" >> release-notes.md
        echo "- **Commit:** ${{ github.sha }}" >> release-notes.md
        echo "- **Branch:** ${{ github.ref_name }}" >> release-notes.md
        echo "- **Target Environment:** ${{ github.event.inputs.target_environment || 'staging' }}" >> release-notes.md
        echo "- **Target URL:** ${{ env.TARGET_URL }}" >> release-notes.md
        echo "- **Staging URL:** ${{ env.STAGING_URL }}" >> release-notes.md
        echo "- **Production URL:** ${{ env.PRODUCTION_URL }}" >> release-notes.md
        echo "" >> release-notes.md
        
        echo "## Test Results Summary" >> release-notes.md
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> release-notes.md
        echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> release-notes.md
        echo "- DAST Security Tests: ${{ needs.dast-security-tests.result }}" >> release-notes.md
        echo "- Security Compliance: ${{ needs.security-compliance-check.result }}" >> release-notes.md
        echo "" >> release-notes.md
        
        echo "## Security Status" >> release-notes.md
        if [ -f "security-compliance-report/security-summary.md" ]; then
          cat security-compliance-report/security-summary.md >> release-notes.md
        else
          echo "Security compliance report not available" >> release-notes.md
        fi

    - name: Create Release Tag
      if: (needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success') && (github.event.inputs.create_release != 'false')
      run: |
        RELEASE_TAG="release-$(date '+%Y%m%d-%H%M%S')"
        echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
        git tag ${RELEASE_TAG}
        git push origin ${RELEASE_TAG}

    - name: Promote to Production
      if: (needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success') && (github.event.inputs.create_release != 'false')
      run: |
        echo "All tests passed. Release is ready for production promotion."
        echo "::notice::Production deployment approved - all quality gates passed"

    - name: Upload Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: |
          release-notes.md
          security-compliance-report/
          e2e-test-results/
          dast-reports/

    - name: Slack Notification
      if: always()
      run: |
        STATUS="SUCCESS"
        if [ "${{ needs.integration-tests.result }}" != "success" ] || [ "${{ needs.e2e-tests.result }}" != "success" ]; then
          STATUS="FAILED"
        fi
        
        echo "Release pipeline completed with status: ${STATUS}"
        echo "Would send Slack notification: Release ${STATUS} for commit ${{ github.sha }}"